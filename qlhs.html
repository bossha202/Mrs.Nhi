<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tr·∫ßn Th·ªã Xu√¢n Nhi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Short+Stack&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #ffe6f0, #e6f2ff, #e6fff9);
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      color: #4a4a4a;
      min-height: 100vh;
      background-image: url('https://hinhnenpowerpoint.com/wp-content/uploads/2024/07/powerpoint-hinh-nen-mau-hong-nhat.jpg');
      background-size: cover;
    }
    h3 {
      font-family: 'Short Stack', cursive;
      color: #ff6f91;
      font-size: 30px;
      text-align: center;
      text-shadow: 2px 2px 5px rgba(255, 111, 145, 0.3);
    }
    .container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 25px;
      box-shadow: 0 10px 40px rgba(255, 111, 145, 0.2);
    }
    .table-responsive {
      height: 580px;
      overflow-x: auto;
      overflow-y: auto;
      border-radius: 20px;
      background: #fff;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      padding: 5px;
    }
    .table th,
    .table td {
      padding: 10px;
      border: 1px solid #f0e6ff;
      vertical-align: middle;
      white-space: nowrap;
    }
    .table thead th {
      background: linear-gradient(to bottom, #ff9a9e, #ff9a9e);
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .table thead tr:nth-child(2) th {
      position: sticky;
      top: 48px;
      z-index: 1;
      background: #ff9a9e;
      color: #ffffff;
    }
    .table tbody tr:hover {
      background: #f9e6ff;
      transition: all 0.2s ease;
    }
    .sticky-name {
      background: #fff;
      position: sticky;
      left: 0;
      z-index: 1;
      font-weight: 700;
      color: #ff6f91;
    }
    .tree-img {
      display: block;
      margin: 0 auto;
      transition: transform 0.3s ease;
    }
    .tree-img:hover {
      transform: scale(1.1);
    }
    .date-picker {
      width: 120px;
      height: 25px;
      border-radius: 10px;
      border: 2px solid #ff9a9e;
      padding: 5px;
      font-size: 14px;
      background: #fff;
      transition: all 0.3s ease;
    }
    .date-picker:focus {
      border-color: #ff6f91;
      box-shadow: 0 0 8px rgba(255, 111, 145, 0.5);
      outline: none;
    }
    input.form-control-sm {
      border-radius: 10px;
      padding: 6px;
      border: 2px solid #ffd4f2;
    }
    input.form-control-sm:focus {
      border-color: #ff6f91;
      box-shadow: 0 0 8px rgba(255, 111, 145, 0.5);
    }
    .action-btn {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 5px;
      transition: all 0.3s ease;
    }
    .btn-outline-primary {
      border-color: #ff6f91;
      color: #ff6f91;
    }
    .btn-outline-primary:hover {
      background: #ff6f91;
      color: #fff;
    }
    .btn-outline-danger {
      border-color: #ff6f91;
      color: #ff6f91;
    }
    .btn-outline-danger:hover {
      background: #ff6f91;
      color: #fff;
    }
    #add-row {
      border-radius: 30px;
      padding: 12px 30px;
      background: linear-gradient(to right, #ff6f91, #ff9a9e);
      border: none;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      transition: all 0.3s ease;
    }
    #add-row:hover {
      background: linear-gradient(to right, #ff9a9e, #ff6f91);
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255, 111, 145, 0.5);
    }
    .nav-tabs .nav-link {
      border: none;
      padding: 8px 15px;
      color: #ff6f91;
      font-weight: 700;
      border-radius: 15px;
      margin: 0 10px;
      transition: all 0.3s ease;
    }
    .nav-tabs .nav-link:hover {
      background: #fff0f6;
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(to right, #ff6f91, #ff9a9e);
      color: #fff;
      box-shadow: 0 5px 20px rgba(255, 111, 145, 0.3);
    }
    .sticky-name input.name {
      font-size: 25px;
      color: #1aff1a;
    }
    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    .action-buttons .btn {
      border-radius: 15px;
      padding: 8px 20px;
      background: linear-gradient(to right, #ff6f91, #ff9a9e);
      border: none;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      transition: all 0.3s ease;
    }
    .action-buttons .btn:hover {
      background: linear-gradient(to right, #ff9a9e, #ff6f91);
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255, 111, 145, 0.5);
    }
    .modal-content {
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 10px 40px rgba(255, 111, 145, 0.3);
    }
    .modal-header {
      background: linear-gradient(to right, #ff6f91, #ff9a9e);
      color: #fff;
      border-radius: 20px 20px 0 0;
      border: none;
    }
    .modal-title {
      font-family: 'Short Stack', cursive;
      font-size: 24px;
    }
    .modal-body {
      max-height: 500px;
      overflow-y: auto;
    }
    .stat-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #f0e6ff;
      transition: all 0.3s ease;
    }
    .stat-item:hover {
      background: #f9e6ff;
    }
    .stat-item img {
      width: 60px;
      margin-right: 20px;
      transition: transform 0.3s ease;
    }
    .stat-item img:hover {
      transform: scale(1.1);
    }
    .stat-item div {
      flex: 1;
    }
    .stat-item .name {
      font-weight: 700;
      color: #ff6f91;
      font-size: 18px;
    }
    .stat-item .score {
      color: #4a4a4a;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container py-4" data-prevent-reload>
    <h3>Mrs Nhi ü©∑ üßë‚Äçüßë‚Äçüßí‚Äçüßí</h3>
    <div class="nav-container">
      <ul class="nav nav-tabs" id="classTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="class1-tab" data-bs-toggle="tab" href="#class1" role="tab" aria-controls="class1" aria-selected="true">L·ªõp 1</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="class2-tab" data-bs-toggle="tab" href="#class2" role="tab" aria-controls="class2" aria-selected="false">L·ªõp 2</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="class3-tab" data-bs-toggle="tab" href="#class3" role="tab" aria-controls="class3" aria-selected="false">L·ªõp 3</a>
        </li>
      </ul>
      <div class="action-buttons">
        <button class="btn" id="stats-btn" data-bs-toggle="modal" data-bs-target="#statsModal">Th·ªëng k√™</button>
        <button class="btn" id="sort-btn">S·∫Øp x·∫øp</button>
      </div>
    </div>
    <div class="tab-content" id="classTabContent">
      <div class="tab-pane fade show active" id="class1" role="tabpanel" aria-labelledby="class1-tab">
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead>
              <tr>
                <th rowspan="2" style="min-width: 15px;">STT</th>
                <th class="sticky-name" rowspan="2" style="min-width: 300px;">H·ªç T√™n</th>
                <th colspan="16">Ch·ªçn Ng√†y H·ªçc (Th·ª© 2/4)</th>
                <th rowspan="2">T·ªïng ƒêi·ªÉm</th>
                <th rowspan="2">C√¢y H·∫°nh Ph√∫c</th>
                <th rowspan="2">H√†nh ƒê·ªông</th>
              </tr>
              <tr>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
              </tr>
            </thead>
            <tbody id="students-body-class1"></tbody>
          </table>
        </div>
      </div>
      <div class="tab-pane fade" id="class2" role="tabpanel" aria-labelledby="class2-tab">
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead>
              <tr>
                <th rowspan="2" style="min-width: 15px;">STT</th>
                <th class="sticky-name" rowspan="2" style="min-width: 260px;">H·ªç T√™n</th>
                <th colspan="16">Ch·ªçn Ng√†y H·ªçc (Th·ª© 2/4)</th>
                <th rowspan="2">T·ªïng ƒêi·ªÉm</th>
                <th rowspan="2">C√¢y H·∫°nh Ph√∫c</th>
                <th rowspan="2">H√†nh ƒê·ªông</th>
              </tr>
              <tr>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
              </tr>
            </thead>
            <tbody id="students-body-class2"></tbody>
          </table>
        </div>
      </div>
      <div class="tab-pane fade" id="class3" role="tabpanel" aria-labelledby="class3-tab">
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead>
              <tr>
                <th rowspan="2" style="min-width: 15px;">STT</th>
                <th class="sticky-name" rowspan="2" style="min-width: 260px;">H·ªç T√™n</th>
                <th colspan="16">Ch·ªçn Ng√†y H·ªçc (Th·ª© 2/4)</th>
                <th rowspan="2">T·ªïng ƒêi·ªÉm</th>
                <th rowspan="2">C√¢y H·∫°nh Ph√∫c</th>
                <th rowspan="2">H√†nh ƒê·ªông</th>
              </tr>
              <tr>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
                <th><span></span><br><input type="date" class="form-control form-control-sm date-picker"></th>
              </tr>
            </thead>
            <tbody id="students-body-class3"></tbody>
          </table>
        </div>
      </div>
    </div>
    <button id="add-row" type="button" class="btn mt-4"><i class="fa-solid fa-user-plus"></i> Th√™m H·ªçc Sinh</button>


    <div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="statsModalLabel">Th·ªëng k√™ H·ªçc sinh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="stats-body">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:3000';
    const TREE_IMAGES = [
      'https://images.weserv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1Ajv7SQnfhvgUR1kw6WxUpRGmePLahGcb',
      'https://images.weserv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D18W0idwXOlpui5GXpjHKqwqAfJTqUG-NK',
      'https://images.weserv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1UUep5ZC16cD60BDj3YAlA3HZbOJgiq49',
      'https://images.weserv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D12LvqDkNQgb87UQ3xN8V3VAIwKs0qEcWj',
      'https://images.weserv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1PNLok9dV4x9CZUXaqHD_jOClbcql9YAe',
      'https://images.weserv.nl/?url=https%3A%2F%2Fdrive.google.com%2Fuc%3Fexport%3Dview%26id%3D1qjpasWckcnn42b6I2zanIyH76ukP-8iH'
    ];
    const TREE_SIZES = [70, 80, 90, 100, 110, 140];
    let isSorted = false;
    let originalStudents = [];

    ;(() => {
      document.addEventListener('submit', e => {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      });
      document.addEventListener('keydown', e => {
        if (e.key === 'Enter' && e.target.matches('input, select, textarea')) {
          e.preventDefault();
          e.stopPropagation();
          e.target.blur();
          return false;
        }
      });
      document.addEventListener('mousedown', e => {
        if (e.detail > 1) e.preventDefault();
      }, { passive: false });
    })();

    let currentScroll = { x: 0, y: 0 };

    function updateSerialNumbers(className) {
      document.querySelectorAll(`#students-body-${className} tr`).forEach((tr, idx) => {
        tr.querySelector('.serial').textContent = idx + 1;
      });
    }

    async function loadSettings() {
      try {
        const res = await fetch(`${API_URL}/settings/1`);
        const { dates } = await res.json();
        const pickers = document.querySelectorAll('.date-picker');
        pickers.forEach((inp, i) => {
          inp.value = dates[i] || '';
        });
      } catch (error) {
        console.error('L·ªói t·∫£i c√†i ƒë·∫∑t:', error);
      }
    }

    const weekdayMap = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];

    function getVietnameseWeekday(dateString) {
      if (!dateString) return '';
      const d = new Date(dateString);
      return weekdayMap[d.getDay()];
    }

    function bindDatePickers() {
      document.querySelectorAll('.date-picker').forEach((inp, idx) => {
        const th = inp.closest('th');
        const labelSpan = th.querySelector('span');
        if (inp.value) {
          labelSpan.textContent = getVietnameseWeekday(inp.value);
        }
        inp.addEventListener('change', async () => {
          labelSpan.textContent = getVietnameseWeekday(inp.value);
          try {
            const dates = Array.from(document.querySelectorAll('.date-picker'))
              .map(i => i.value || null);
            await fetch(`${API_URL}/settings/1`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dates })
            });
          } catch (err) {
            console.error('L·ªói l∆∞u c√†i ƒë·∫∑t:', err);
          }
        });
      });
    }

    function getTreeIndex(total) {
      if (total <= 0) return 0;
      if (total <= 15) return 1;
      if (total <= 30) return 2;
      if (total <= 40) return 3;
      if (total <= 50) return 4;
      if (total <= 55) return 5;
      return TREE_IMAGES.length - 1;
    }

    function renderStudent(student) {
      const tr = document.createElement('tr');
      tr.dataset.id = student.id;
      const total = student.scores.reduce((a, b) => a + b, 0);
      const treeIndex = getTreeIndex(total);
      const size = TREE_SIZES[treeIndex];
      tr.innerHTML = `
        <td class="serial"></td>
        <td class="sticky-name"><input type="text" class="form-control form-control-sm name" value="${student.name}" placeholder=""></td>
        ${student.scores.map(score => `<td><input type="number" min="0" class="form-control form-control-sm score" value="${score}"></td>`).join('')}
        <td class="total">${total}</td>
        <td><img src="${TREE_IMAGES[treeIndex]}" class="tree-img" data-tree-index="${treeIndex}" style="width:${size}px"></td>
        <td>
          <button class="btn btn-outline-primary btn-sm action-btn refresh-btn" title="L√†m m·ªõi"><i class="fa-solid fa-arrows-rotate"></i></button>
          <button class="btn btn-outline-danger btn-sm action-btn delete-btn" title="X√≥a"><i class="fa-solid fa-trash-can"></i></button>
        </td>
      `;
      tr.querySelector('.name').addEventListener('change', async e => {
        student.name = e.target.value.trim();
        await saveStudent(student);
      });
      tr.querySelectorAll('.score').forEach((input, idx) => {
        input.addEventListener('input', () => {
          currentScroll = { x: window.scrollX, y: window.scrollY };
          student.scores[idx] = parseInt(input.value) || 0;
          updateRowUI(tr, student.scores);
          requestAnimationFrame(() => window.scrollTo(currentScroll.x, currentScroll.y));
        });
        input.addEventListener('change', async () => {
          await saveStudent(student);
        });
      });
      tr.querySelector('.refresh-btn').addEventListener('click', async () => {
        student.name = '';
        student.scores.fill(0);
        tr.querySelector('.name').value = '';
        tr.querySelectorAll('.score').forEach(inp => inp.value = 0);
        updateRowUI(tr, student.scores);
        await saveStudent(student);
      });
      tr.querySelector('.delete-btn').addEventListener('click', async () => {
        if (!confirm('X√°c nh·∫≠n x√≥a h·ªçc sinh n√†y?')) return;
        await fetch(`${API_URL}/students/${student.id}`, { method: 'DELETE' });
        tr.remove();
        updateSerialNumbers(student.class);
      });
      return tr;
    }

    async function saveStudent(student) {
      try {
        await fetch(`${API_URL}/students/${student.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: student.name, scores: student.scores, class: student.class })
        });
      } catch (error) {
        console.error('L·ªói l∆∞u h·ªçc sinh:', error);
      }
    }

    function updateRowUI(row, scores) {
      const total = scores.reduce((a, b) => a + b, 0);
      const treeIndex = getTreeIndex(total);
      const size = TREE_SIZES[treeIndex];
      const totalCell = row.querySelector('.total');
      totalCell.textContent = total;
      const img = row.querySelector('img');
      if (parseInt(img.dataset.treeIndex) !== treeIndex) {
        img.src = TREE_IMAGES[treeIndex];
        img.dataset.treeIndex = treeIndex;
        img.style.width = size + 'px';
      }
    }

    async function loadStudents(className, sort = false) {
      try {
        const res = await fetch(`${API_URL}/students?class=${className}`);
        let students = await res.json();
        if (sort) {
          students.sort((a, b) => {
            const totalA = a.scores.reduce((x, y) => x + y, 0);
            const totalB = b.scores.reduce((x, y) => x + y, 0);
            return totalB - totalA;
          });
        }
        const tbody = document.getElementById(`students-body-${className}`);
        tbody.innerHTML = '';
        students.forEach(s => tbody.appendChild(renderStudent(s)));
        updateSerialNumbers(className);
        if (!sort) {
          originalStudents = [...students];
        }
      } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch:', error);
      }
    }

    async function showStats() {
      const activeTab = document.querySelector('.nav-link.active');
      const className = activeTab.id.split('-')[0];
      try {
        const res = await fetch(`${API_URL}/students?class=${className}`);
        const students = await res.json();
        const statsBody = document.getElementById('stats-body');
        statsBody.innerHTML = '';
        students.forEach(student => {
          const total = student.scores.reduce((a, b) => a + b, 0);
          const treeIndex = getTreeIndex(total);
          const statItem = document.createElement('div');
          statItem.className = 'stat-item';
          statItem.innerHTML = `
            <img src="${TREE_IMAGES[treeIndex]}" class="tree-img">
            <div>
              <div class="name">${student.name || 'Ch∆∞a c√≥ t√™n'}</div>
              <div class="score">T·ªïng ƒëi·ªÉm: ${total}</div>
            </div>
          `;
          statsBody.appendChild(statItem);
        });
      } catch (error) {
        console.error('L·ªói t·∫£i th·ªëng k√™:', error);
      }
    }

    document.getElementById('add-row').addEventListener('click', async () => {
      const activeTab = document.querySelector('.nav-link.active');
      const className = activeTab.id.split('-')[0];
      const res = await fetch(`${API_URL}/students`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: 'H·ªçc sinh m·ªõi', scores: new Array(16).fill(0), class: className })
      });
      const newStudent = await res.json();
      document.getElementById(`students-body-${className}`).appendChild(renderStudent(newStudent));
      updateSerialNumbers(className);
    });

    document.getElementById('stats-btn').addEventListener('click', showStats);

    document.getElementById('sort-btn').addEventListener('click', () => {
      const activeTab = document.querySelector('.nav-link.active');
      const className = activeTab.id.split('-')[0];
      if (!isSorted) {
        loadStudents(className, true);
        isSorted = true;
      } else {
        const tbody = document.getElementById(`students-body-${className}`);
        tbody.innerHTML = '';
        originalStudents.forEach(s => tbody.appendChild(renderStudent(s)));
        updateSerialNumbers(className);
        isSorted = false;
      }
    });

    document.querySelectorAll('.nav-link').forEach(tab => {
      tab.addEventListener('shown.bs.tab', function (e) {
        const className = e.target.id.split('-')[0];
        loadStudents(className);
        isSorted = false;
      });
    });

    (async () => {
      await loadSettings();
      bindDatePickers();
      await loadStudents('class1');
    })();
  </script>
</body>
</html>